\documentclass[10pt,a4paper,openright,twoside]{report}

\usepackage[cm-default]{fontspec}
\usepackage{xunicode}
\usepackage{xltxtra}
\usepackage{ifpdf}
\usepackage[utf8]{inputenc}
\usepackage[UKenglish]{babel}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage[obeyspaces,spaces]{url}
% Uncomment the next when generating not for print. The 'draft' option turns link colouring off.
% \usepackage[breaklinks=true,colorlinks=true,linkcolor=MidnightBlue,urlcolor=OliveGreen]{hyperref}
\usepackage[breaklinks=true,draft]{hyperref}
\usepackage{listings}
\usepackage[a4paper,footnotesep=20pt,asymmetric,hmarginratio=3:2]{geometry}
\usepackage{textcomp}
\usepackage{setspace}
\usepackage{amsmath}
\usepackage[bottom]{footmisc}
\usepackage[bf]{caption}
\usepackage{verbatim}
\usepackage{titlesec}
\usepackage{enumitem}
\usepackage{tocloft}

\usepackage{tikz}
\usetikzlibrary{trees,chains,backgrounds,fit,calc,shapes.multipart}

\tikzset{
  generic node/.style={
    rectangle,rounded corners=2mm,
    very thick,
    text height=1.5ex,text depth=.25ex,
    align=center,
    text=black
  },
  grey node/.style={
    generic node,
    draw=black!50,
    top color=white,bottom color=black!20
  },
  red node/.style={
    generic node,
    draw=red!50!black!50,
    top color=white,bottom color=red!50!black!20
  },
  blue node/.style={
    generic node,
    draw=MidnightBlue!50!black!50,
    top color=white,bottom color=MidnightBlue!50!black!20
  },
  green node/.style={
    generic node,
    draw=OliveGreen!50!black!50,
    top color=white,bottom color=OliveGreen!50!black!20
  },
  object/.style={blue node,font=\ttfamily},
  class/.style={grey node,font=\ttfamily},
  sclass/.style={red node,font=\ttfamily},
  module/.style={green node,font=\ttfamily},
  multiline node/.style={
    text height=,text depth=
  },
  line/.style={
    thick,
    draw=black!50,
    color=black!50,
    text=black!70
  },
  every edge/.style={line},
  every path/.style={line,rounded corners},
  >=stealth,
  background/.style={
    fill=black!5,rounded corners
  },
  diagram transition/.style={
    ->,shorten >=1mm,shorten <=1mm,
    dashed,
    every node/.style={
      above,align=center,
      midway,text width=1.5cm,
      font=\normalfont,
      text=black
    }
  }
}

\definecolor{verylightgrey}{gray}{0.95}
\definecolor{lightgrey}{gray}{0.85}
\definecolor{code}{gray}{0.2}
\definecolor{midgrey}{gray}{0.4}

\lstset{
  language=Ruby,                % choose the language of the code
  showstringspaces=false,       % underline spaces within strings
  tabsize=2,	                  % sets default tabsize to 2 spaces
  rulesepcolor=\color{Gray},
  basicstyle={\ttfamily\small\singlespacing},
  upquote=true,
  keywordstyle=\bfseries,
  commentstyle=\color{midgrey}\em,
  stringstyle=\color{midgrey},
  backgroundcolor=\color{verylightgrey},
  frame=single,
  frameround=tttt,
  rulecolor=\color{lightgrey}
}
\lstdefinelanguage{treetop}{
  keywords={rule,end,module,grammar},
  string=[b]{'},
  morestring=[b]{"},
  comment=[l]{\#}
}

\setmainfont[Mapping=tex-text-with-ligs,SmallCapsFont={GaramondClassicoSC}]{GaramondClassico}
\setmonofont[Scale=0.8]{Bitstream Vera Sans Mono}

\onehalfspace
\pagestyle{headings}

\numberwithin{figure}{section}

\def\gettitle{Carat: Seeking the essence of Ruby}
\def\getauthor{Jonathan Leighton}
\def\getdate{\today}

\title{\gettitle}
\author{\getauthor}
\date{\getdate}

\hypersetup{
  pdftitle=\gettitle,
  pdfsubject=\gettitle,
  pdfauthor=\getauthor,
  pdfcreationdate=\getdate
}

% Use the url package to define a command for typesetting inline code
\DeclareUrlCommand\code{\def\UrlFont{\ttfamily \color{code}}}

% \url commands don't work in "moving arguments" (captions, sections, etc), so this is a fallback
% command which doesn't allow handle line breaks (but that shouldn't be a problem in these cases)
\newcommand{\movingcode}[1]{\texttt{\textcolor{code}{#1}}}

\newcommand{\defn}[1]{\emph{{#1}}}

\def\subsectionautorefname{section}

\setlength{\parindent}{0pt}
\setlength{\parskip}{2ex}
\setlength{\captionmargin}{50pt}

\titleformat{\chapter}[block]{\bfseries}{\makebox[2cm][r]{\fontsize{50}{55}\selectfont\thechapter}}{0.5cm}{\Huge\scshape}
\titlespacing{\chapter}{-2.5cm}{0pt}{3em}

\titleformat{\section}[block]{\bfseries\Large}{\makebox[2cm][r]{\thesection}}{0.3cm}{}
\titlespacing{\section}{-2.3cm}{1.5em}{0.5em}

\titleformat{\subsection}[block]{\bfseries\large}{\makebox[2cm][r]{\thesubsection}}{0.3cm}{}
\titlespacing{\subsection}{-2.3cm}{1.5em}{0.5em}

\setlength{\cftbeforetoctitleskip}{1cm}
\setlength{\cftaftertoctitleskip}{3em}
\renewcommand{\cfttoctitlefont}{\Huge\scshape}

\setlist{leftmargin=0cm,listparindent=0cm}
\begin{document}
  \pagenumbering{roman}
  \include{titlepage}
	\tableofcontents
	
	\cleardoublepage
	\pagenumbering{arabic}
	\include{introduction}
	\include{implementation}
	\include{implementation_specifics}
	\include{testing}
	\include{conclusions}
	\include{references}
	
	\appendix
	\include{language_overview}
	\singlespacing
	\include{test_output}
	\include{code_listing}
\end{document}

